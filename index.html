<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internet Status Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.4.0/uicons-thin-solid/css/uicons-thin-solid.css'>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><path fill=%22%232563eb%22 d=%22M12,0A12,12,0,1,0,24,12,12.013,12.013,0,0,0,12,0ZM11.25,1.5a10.5,10.5,0,1,1,0,21c-5.185,0-9.44-3.93-10.395-9H10.5V1.536A10.435,10.435,0,0,1,11.25,1.5ZM12.75,1.536V13.5h9.864A10.5,10.5,0,0,0,12.75,1.536Z%22/></svg>">

    <style>
        /* Base font */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Simple spinning animation */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .spinner {
            display: inline-block;
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Jitter progress bar animation */
        .progress-bar {
            transition: width 0.25s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800 p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        
        <header class="mb-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600">My-Internet-Tester</h1>
            
            <div class="text-sm text-gray-500">
                Created by <a href="https://github.com/Biraj2004" target="_blank" rel="noopener noreferrer" class="font-medium text-blue-600 hover:underline inline-flex items-center space-x-1.5">
                    <span class="font-bold">Biraj Sarkar</span>
                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.22.48-2.69-1.07-2.69-1.07-.36-.92-.89-1.17-.89-1.17-.73-.5.05-.49.05-.49.81.06 1.23.83 1.23.83.72 1.22 1.89.87 2.35.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.28.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                </a>
            </div>
        </header>
        
        <div class="text-center mb-6"> <h1 id="status-title" class="text-7xl md:text-8xl font-extrabold text-green-600 transition-colors duration-300">
                YES!
            </h1>
            <p id="status-subtitle" class="text-xl md:text-2xl font-medium text-gray-600">Your Internet is Working!</p>
            
            <p id="loading-message" class="text-lg font-medium text-blue-600 mt-4 flex items-center justify-center space-x-2">
                <span class="spinner"></span>
                <span>Hold On! I am Checking...</span>
            </p>

            <div class="mt-4">
                <label for="auto-test" class="text-sm font-medium text-gray-500 mr-2">Auto-Test:</label>
                <select id="auto-test" class="rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="3000">3 sec</option>
                    <option value="5000">5 sec</option>
                    <option value="10000">10 sec</option>
                    <option value="15000">15 sec</option>
                    <option value="30000">30 sec</option>
                </select>
            </div>
        </div>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
            
            <div class="bg-white rounded-xl shadow-lg p-6 md:col-span-2">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <svg class="h-6 w-6 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0 1 9.75 19.875V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                        </svg>
                        <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Network Statistics</h2>
                    </div>
                </div>
                <p id="ip-address" class="text-3xl font-bold text-gray-900 truncate">
                    <span class="spinner inline-block align-middle"></span>
                </p>
                <div class="mt-4 space-y-2 text-sm text-gray-700">
                    <div class="flex justify-between flex-wrap">
                        <span class="font-medium text-gray-500 mr-2">ISP:</span>
                        <span id="isp-details" class="font-semibold text-right break-all"><span class="spinner inline-block align-middle"></span></span>
                    </div>
                    <div class="flex justify-between flex-wrap">
                        <span class="font-medium text-gray-500 mr-2">Location:</span>
                        <span id="location-details" class="font-semibold text-right"><span class="spinner inline-block align-middle"></span></span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-3">
                    <svg class="h-6 w-6 text-red-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Ping (Latency)</h2>
                </div>
                <div class="flex items-baseline">
                    <p id="ping" class="text-3xl font-bold text-gray-900">
                        <span class="spinner inline-block align-middle"></span>
                    </p>
                    <span id="ping-unit" class="text-xl font-medium text-gray-600 ml-2"></span>
                </div>
                <p class="text-xs text-gray-400 italic mt-2">
                    Testing against global CDNs
                </p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-3">
                    <svg class="h-6 w-6 text-purple-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" />
                    </svg>
                    <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">DNS Resolution</h2>
                </div>
                <div class="flex items-baseline">
                    <p id="dns-resolution" class="text-3xl font-bold text-gray-900">
                        <span class="spinner inline-block align-middle"></span>
                    </p>
                    <span id="dns-unit" class="text-xl font-medium text-gray-600 ml-2">ms</span>
                </div>
                <p class="text-xs text-gray-400 italic mt-2">
                    Testing against DoH resolvers
                </p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 md:col-span-2">
                <div class="flex items-center mb-4">
                    <svg class="h-6 w-6 text-teal-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0 1 9.75 19.875V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                    </svg>
                    <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Jitter Test</h2>
                </div>
                
                <div id="jitter-controls" class="flex flex-wrap gap-3">
                    <button data-duration="30" class="jitter-button bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        Run 30 Sec Test
                    </button>
                    <button data-duration="60" class="jitter-button bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        Run 1 Min Test
                    </button>
                    <button data-duration="120" class="jitter-button bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        Run 2 Min Test
                    </button>
                </div>
                
                <div id="jitter-progress-container" class="mt-4 hidden">
                    <div class="flex justify-between mb-1">
                        <span id="jitter-status" class="text-sm font-medium text-blue-700">Running test...</span>
                        <span id="jitter-timer" class="text-sm font-medium text-blue-700">0s</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="jitter-progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div id="jitter-results" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-center hidden">
                    <div>
                        <p class="text-xs text-gray-500 uppercase">Jitter</p>
                        <p id="jitter-result" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase">Avg. Latency</p>
                        <p id="jitter-avg" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase">Min. Latency</p>
                        <p id="jitter-min" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase">Max. Latency</p>
                        <p id="jitter-max" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 md:col-span-2">
                <div class="flex items-center mb-3">
                    <svg class="h-6 w-6 text-gray-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A1.875 1.875 0 0 1 18.125 22.5H5.875a1.875 1.875 0 0 1-1.374-2.382Z" />
                    </svg>
                    <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">User Agent</h2>
                </div>
                <p id="user-agent" class="text-sm text-gray-700 break-words">
                    <span class="spinner inline-block align-middle"></span>
                </p>
            </div>
        </main>
    </div>

    <div id="bottom-checking-message" class="fixed bottom-0 left-0 right-0 bg-white p-3 shadow-[0_-2px_10px_rgba(0,0,0,0.1)] text-center transition-all duration-300 transform translate-y-full">
        <div class="max-w-4xl mx-auto flex items-center justify-center">
            <span class="spinner text-blue-600 mr-2"></span>
            <span class="font-medium text-blue-600">Hold On! I am Checking...</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const statusTitle = document.getElementById('status-title');
            const statusSubtitle = document.getElementById('status-subtitle');
            const ipEl = document.getElementById('ip-address');
            const ispEl = document.getElementById('isp-details');
            const locationEl = document.getElementById('location-details');
            const pingEl = document.getElementById('ping');
            const pingUnitEl = document.getElementById('ping-unit');
            const dnsEl = document.getElementById('dns-resolution');
            const dnsUnitEl = document.getElementById('dns-unit');
            const uaEl = document.getElementById('user-agent');
            const loadingMessage = document.getElementById('loading-message');
            const autoTestSelect = document.getElementById('auto-test');
            const bottomMessage = document.getElementById('bottom-checking-message');
            const bottomMessageSpinner = bottomMessage.querySelector('.spinner');
            const bottomMessageText = bottomMessage.querySelector('span:last-child');
            
            // Jitter Elements
            const jitterControls = document.getElementById('jitter-controls');
            const jitterButtons = document.querySelectorAll('.jitter-button');
            const jitterProgressContainer = document.getElementById('jitter-progress-container');
            const jitterProgressBar = document.getElementById('jitter-progress-bar');
            const jitterStatus = document.getElementById('jitter-status');
            const jitterTimer = document.getElementById('jitter-timer');
            const jitterResults = document.getElementById('jitter-results');
            const jitterResultEl = document.getElementById('jitter-result');
            const jitterAvgEl = document.getElementById('jitter-avg');
            const jitterMinEl = document.getElementById('jitter-min');
            const jitterMaxEl = document.getElementById('jitter-max');

            // --- State ---
            let pingIntervalId = null;
            let jitterAbortController = null;
            let currentPingRate = parseInt(autoTestSelect.value, 10);
            
            // CHANGED: Replaced 'isFirstLoad' with 'shouldFetchIp' for better control
            let shouldFetchIp = true;
            
            const baseFetchOptions = {
                cache: 'no-store'
            };

            // --- 1. Online/Offline Status Handler ---
            function updateOnlineStatus(isOnline = navigator.onLine) {
                if (isOnline) {
                    // --- GOING ONLINE ---
                    statusTitle.textContent = 'YES!';
                    statusTitle.classList.remove('text-red-600', 'text-blue-600');
                    statusTitle.classList.add('text-green-600');
                    statusSubtitle.textContent = 'Your Internet is Working!';
                    
                    loadingMessage.classList.remove('text-red-600');
                    loadingMessage.classList.add('text-blue-600');
                    bottomMessageSpinner.classList.remove('text-red-600');
                    bottomMessageSpinner.classList.add('text-blue-600');
                    bottomMessageText.classList.remove('text-red-600');
                    bottomMessageText.classList.add('text-blue-600');

                    startAutoCheckLoop(currentPingRate);

                } else {
                    // --- GOING OFFLINE ---
                    statusTitle.textContent = 'NO!';
                    statusTitle.classList.remove('text-green-600', 'text-blue-600');
                    statusTitle.classList.add('text-red-600');
                    statusSubtitle.textContent = 'Your Internet is Not Working!';
                    
                    loadingMessage.classList.remove('text-blue-600');
                    loadingMessage.classList.add('text-red-600');
                    bottomMessageSpinner.classList.remove('text-blue-600');
                    bottomMessageSpinner.classList.add('text-red-600');
                    bottomMessageText.classList.remove('text-blue-600');
                    bottomMessageText.classList.add('text-red-600');
                    bottomMessageText.textContent = 'You are offline.';

                    if (pingIntervalId) {
                        clearInterval(pingIntervalId);
                        pingIntervalId = null;
                    }

                    if (jitterAbortController) {
                        jitterAbortController.abort();
                    }

                    loadingMessage.classList.add('hidden');
                    bottomMessage.classList.remove('translate-y-full'); 
                    ipEl.textContent = 'IPV4 - Offline';
                    ispEl.textContent = 'Offline';
                    locationEl.textContent = 'Offline';
                    pingEl.textContent = 'Offline';
                    pingUnitEl.textContent = '';
                    dnsEl.textContent = 'Offline';
                    dnsUnitEl.textContent = '';
                    
                    // FIX: If we go offline, we MUST fetch IP again when we come back.
                    shouldFetchIp = true;
                }
            }

            // --- 2. Get IP Address & GeoIP Info (Robust Fallback & Retry Logic) ---
            // CHANGED: Now returns TRUE if successful, FALSE if failed.
            async function getIPAndGeo() {
                let ip = null;
                try {
                    const ipResponse = await fetch('https://api.ipify.org?format=json', baseFetchOptions);
                    if (!ipResponse.ok) throw new Error('Failed to fetch IP');
                    const ipData = await ipResponse.json();
                    ip = ipData.ip;
                    ipEl.textContent = `IPV4 - ${ip}`;
                } catch (error) {
                    console.error('Failed to fetch IP:', error);
                    // If we can't get IP, we can't get Geo. Mark as unavailable but return FALSE to retry.
                    ipEl.textContent = 'IPV4 - Unavailable';
                    ispEl.textContent = 'Unavailable';
                    locationEl.textContent = 'Unavailable';
                    return false; 
                }

                try {
                    const geoResponse = await fetch(`https://ipapi.co/${ip}/json/`, baseFetchOptions);
                    if (!geoResponse.ok) throw new Error('ipapi.co failed or blocked');
                    const data = await geoResponse.json();
                    if (data.error) throw new Error(data.reason);

                    ispEl.textContent = data.org || 'N/A'; 
                    locationEl.textContent = `${data.city || 'N/A'}, ${data.region || 'N/A'}, ${data.country_code || 'N/A'}`;
                
                } catch (error) {
                    console.warn('Primary GeoIP failed, trying fallback...');
                    try {
                        const fallbackResponse = await fetch(`https://freeipapi.com/api/json/${ip}`, baseFetchOptions);
                        if (!fallbackResponse.ok) throw new Error('Fallback GeoIP failed');
                        const data = await fallbackResponse.json();

                        ispEl.textContent = data.ispName || 'N/A';
                        locationEl.textContent = `${data.cityName || 'N/A'}, ${data.regionName || 'N/A'}, ${data.countryCode || 'N/A'}`;

                    } catch (fallbackError) {
                        console.error('Fallback GeoIP also failed:', fallbackError);
                        ispEl.textContent = 'Unavailable';
                        locationEl.textContent = 'Unavailable';
                    }
                }
                
                return true; // Success
            }

            // --- 3. Get User Agent ---
            async function getUserAgent() {
                uaEl.textContent = navigator.userAgent;
            }

            // --- 4. Improved Ping & DNS (OPTIMIZED FOR SPEED) ---

            // Utility: median
            function median(arr){ if(!arr || !arr.length) return null; const s = [...arr].sort((a,b)=>a-b); const mid = Math.floor(s.length/2); return s.length%2 ? s[mid] : Math.round((s[mid-1]+s[mid])/2); }

            const PING_ENDPOINTS = [
                { name: 'google204', url: 'https://www.google.com/generate_204' },
                { name: 'clients3', url: 'https://clients3.google.com/generate_204' },
                { name: 'cloudflare-trace', url: 'https://cloudflare-dns.com/cdn-cgi/trace' }
            ];

            const DOH_RESOLVERS = [
                { name: 'Cloudflare', url: 'https://cloudflare-dns.com/dns-query?name=google.com&type=A', accept: 'application/dns-json' },
                { name: 'Google', url: 'https://dns.google/resolve?name=google.com&type=A', accept: 'application/dns-json' }
            ];

            // OPTIMIZATION 1: Reduced timeout from 2500ms to 1000ms. 
            async function measureFetchRTT(url, opts = {}) {
                const start = performance.now();
                try {
                    const sep = url.includes('?') ? '&' : '?';
                    const controller = new AbortController();
                    
                    // FAIL FAST: Timeout reduced to 1 second
                    const timeoutId = setTimeout(() => controller.abort(), 1000); 
                    
                    const response = await fetch(url + sep + '_=' + Date.now(), { 
                        ...opts, 
                        cache: 'no-store', 
                        mode: 'cors', 
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok && response.status !== 204) {
                        throw new Error('Network response was not ok');
                    }

                    const end = performance.now();
                    return Math.round(end - start);
                } catch (e) {
                    return null;
                }
            }

            // OPTIMIZATION 2: Reduced attempts per server.
            async function measureEndpointMedian(url, attempts = 1, opts = {}) {
                const times = [];
                for (let i = 0; i < attempts; i++) {
                    const t = await measureFetchRTT(url, opts);
                    if (t !== null) times.push(t);
                    if (attempts > 1) await new Promise(r => setTimeout(r, 50)); 
                }
                return times.length ? median(times) : null;
            }

            // OPTIMIZATION 3: Parallel Execution (The "Race")
            async function getPingLatency() {
                try {
                    // Run all probes in parallel
                    const promises = PING_ENDPOINTS.map(ep => measureEndpointMedian(ep.url, 1));
                    const results = await Promise.all(promises);
                    
                    const valid = results.filter(ms => ms !== null);
                    
                    // If NO server responded, we are definitely offline
                    if (!valid.length) {
                        // Last ditch effort: check IP API once
                        const fallback = await measureFetchRTT('https://api.ipify.org?format=json');
                        return fallback; 
                    }

                    // Return the best (median) latency found
                    return median(valid);
                } catch (e) {
                    console.error('getPingLatency error', e);
                    return null;
                }
            }

            // OPTIMIZATION 4: Parallel DNS Check
            async function getDnsLatency() {
                try {
                    const promises = DOH_RESOLVERS.map(r => {
                        const opts = { headers: { 'Accept': r.accept }, cache: 'no-store', mode: 'cors' };
                        return measureEndpointMedian(r.url, 1, opts);
                    });
                    
                    const results = await Promise.all(promises);
                    const valid = results.filter(ms => ms !== null);
                    
                    if (!valid.length) return null;
                    return median(valid);
                } catch (e) {
                    console.error('getDnsLatency error', e);
                    return null;
                }
            }

            // --- 5. Start/Update Auto-Check Loop ---
            function startAutoCheckLoop(rate) {
                if (pingIntervalId) {
                    clearInterval(pingIntervalId);
                }
                currentPingRate = parseInt(rate, 10);

                const runCheckCycle = async () => {
                    if (jitterAbortController) {
                        console.log("Auto-check paused during jitter test.");
                        return;
                    }
                    
                    // 1. Show "WAIT!" state
                    statusTitle.textContent = 'WAIT!';
                    statusSubtitle.textContent = 'Checking again soon...'; 
                    statusTitle.classList.remove('text-green-600', 'text-red-600');
                    statusTitle.classList.add('text-blue-600');
                    
                    bottomMessage.classList.remove('translate-y-full');
                    bottomMessageText.textContent = 'Hold On! I am Checking...';
                    
                    if (shouldFetchIp) {
                        loadingMessage.classList.add('hidden');
                    }

                    // 2. Run probes immediately
                    const latency = await getPingLatency();
                    const dnsLatency = await getDnsLatency();

                    // 3. Update UI based on probe results
                    if (!navigator.onLine) {
                        updateOnlineStatus(false);
                        return;
                    }

                    if (latency !== null) {
                        // --- SUCCESS STATE ---
                        statusTitle.textContent = 'YES!';
                        statusSubtitle.textContent = 'Your Internet is Working!';
                        statusTitle.classList.remove('text-blue-600');
                        statusTitle.classList.add('text-green-600');
                        
                        pingEl.textContent = latency;
                        pingUnitEl.textContent = 'ms';
                        
                        if (dnsLatency !== null) {
                            dnsEl.textContent = dnsLatency;
                            dnsUnitEl.textContent = 'ms';
                        } else {
                            dnsEl.textContent = 'Failed';
                            dnsUnitEl.textContent = '';
                        }

                        // FIX: Retry Logic.
                        // If we haven't successfully fetched IP yet, try now.
                        // If it fails, 'shouldFetchIp' stays TRUE, so we try again next loop.
                        if (shouldFetchIp) {
                            const success = await getIPAndGeo(); 
                            if (success) {
                                shouldFetchIp = false; // Stop retrying once we have it.
                                getUserAgent();
                            }
                        }
                    } else {
                        // --- FAILURE STATE ---
                        statusTitle.textContent = 'NO!';
                        statusSubtitle.textContent = 'Internet Not Working';
                        statusTitle.classList.remove('text-blue-600');
                        statusTitle.classList.add('text-red-600');
                        
                        pingEl.textContent = 'Failed';
                        pingUnitEl.textContent = '';
                        dnsEl.textContent = 'Failed';
                        dnsUnitEl.textContent = '';
                        
                        if (shouldFetchIp) {
                            ipEl.textContent = 'IPV4 - Unavailable';
                            ispEl.textContent = 'Unavailable';
                            locationEl.textContent = 'Unavailable';
                            getUserAgent();
                        }

                        // If ping fails, force an IP check when we come back
                        shouldFetchIp = true;
                    }
                    
                    bottomMessage.classList.add('translate-y-full');
                };
                
                runCheckCycle(); 
                pingIntervalId = setInterval(runCheckCycle, currentPingRate);
            }

            // --- 6. Jitter Test Logic ---
            function calculateJitterStats(latencies) {
                if (!latencies || latencies.length < 2) {
                    return { jitter: 0, avg: 0, min: 0, max: 0 };
                }

                let jitters = [];
                let sum = latencies[0];
                let min = latencies[0];
                let max = latencies[0];

                for (let i = 1; i < latencies.length; i++) {
                    let diff = Math.abs(latencies[i] - latencies[i-1]);
                    jitters.push(diff);
                    sum += latencies[i];
                    if (latencies[i] < min) min = latencies[i];
                    if (latencies[i] > max) max = latencies[i];
                }

                const jitterSum = jitters.reduce((a, b) => a + b, 0);
                const avgJitter = jitterSum / jitters.length;
                const avgLatency = sum / latencies.length;

                return {
                    jitter: Math.round(avgJitter),
                    avg: Math.round(avgLatency),
                    min: min,
                    max: max
                };
            }

            async function runJitterTest(durationSeconds) {
                if (!navigator.onLine) {
                    alert('Cannot start test while offline.');
                    return;
                }
                
                if (jitterAbortController) {
                    jitterAbortController.abort();
                }
                jitterAbortController = new AbortController();

                jitterButtons.forEach(btn => btn.disabled = true);
                jitterResults.classList.add('hidden');
                jitterProgressContainer.classList.remove('hidden');
                jitterStatus.textContent = 'Running test...';
                
                const pingsPerSecond = 2;
                let latencies = [];
                const intervalTime = 1000 / pingsPerSecond;
                const startTime = Date.now();

                const testInterval = setInterval(async () => {
                    if (!navigator.onLine) {
                        jitterAbortController.abort();
                        return;
                    }

                    const latency = await getPingLatency();
                    if (latency !== null) {
                        latencies.push(latency);
                    }

                    const elapsedTime = (Date.now() - startTime) / 1000;
                    const progress = Math.min((elapsedTime / durationSeconds) * 100, 100);
                    jitterProgressBar.style.width = `${progress}%`;
                    jitterTimer.textContent = `${Math.round(elapsedTime)}s / ${durationSeconds}s`;

                    if (elapsedTime >= durationSeconds) {
                        clearInterval(testInterval);
                        jitterAbortController = null;

                        const stats = calculateJitterStats(latencies);
                        jitterResultEl.textContent = `${stats.jitter} ms`;
                        jitterAvgEl.textContent = `${stats.avg} ms`;
                        jitterMinEl.textContent = `${stats.min} ms`;
                        jitterMaxEl.textContent = `${stats.max} ms`;
                        
                        jitterResults.classList.remove('hidden');
                        jitterProgressContainer.classList.add('hidden');
                        jitterButtons.forEach(btn => btn.disabled = false);
                        jitterStatus.textContent = 'Test complete';
                    }

                }, intervalTime);

                jitterAbortController.signal.addEventListener('abort', () => {
                    clearInterval(testInterval);
                    jitterAbortController = null;
                    jitterButtons.forEach(btn => btn.disabled = false);
                    jitterProgressContainer.classList.add('hidden');
                    
                    if(!navigator.onLine) {
                        jitterStatus.textContent = 'Test Aborted (Offline)';
                    } else {
                        jitterStatus.textContent = 'Test Aborted';
                    }
                });
            }

            // --- 7. Initial Load Function ---
            async function initialLoad() {
                if (!navigator.onLine) {
                    updateOnlineStatus(false);
                    return;
                }
                
                loadingMessage.classList.remove('hidden');
                startAutoCheckLoop(currentPingRate);
            }

            // --- 8. Event Listeners ---
            window.addEventListener('online', () => updateOnlineStatus(true));
            window.addEventListener('offline', () => updateOnlineStatus(false));

            autoTestSelect.addEventListener('change', (e) => {
                startAutoCheckLoop(e.target.value);
            });

            jitterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const duration = parseInt(button.getAttribute('data-duration'), 10);
                    runJitterTest(duration);
                });
            });

            initialLoad();
        });
    </script>
</body>
</html>
